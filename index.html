<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ランダムユニコード生成</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }

        #unicode-container {
            width: 200px;
            height: 200px;
            font-size: 150px;
            text-align: center;
            line-height: 200px; /* 縦中央揃え */
            margin-bottom: 10px;
            overflow: hidden; /* 内容がはみ出さないようにする */
        }

        #unicode-info {
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
        }

        #history, #favorites, #haiku {
            margin-top: 20px;
            font-size: 16px;
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 300px;
            text-align: center;
        }

        button {
            padding: 12px 25px;
            margin: 10px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="unicode-container">?</div>
    <div id="unicode-info">選ばれた文字の情報がここに表示されます</div>

    <div class="section">
        <button onclick="generateRandomUnicode()">新しいユニコードを表示</button>
        <button onclick="addToFavorites()">お気に入りに追加</button>
        <button onclick="generateHaiku()">俳句を生成</button>
    </div>

    <div id="history">履歴: </div>
    <div id="favorites">お気に入りリスト: </div>
    <div id="haiku">俳句生成エリア</div>

    <canvas id="char-check-canvas" style="display:none;"></canvas>

    <script>
        let history = JSON.parse(localStorage.getItem('history')) || [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

        window.onload = () => {
            updateHistory();
            updateFavorites();
            generateRandomUnicode();
        };

        // ランダムなユニコード文字を生成し、表示可能な文字が見つかるまで繰り返す関数
        function generateRandomUnicode() {
            let randomChar;
            let isRenderable = false;

            while (!isRenderable) {
                const randomCodePoint = Math.floor(Math.random() * 0x10FFFF);
                randomChar = String.fromCodePoint(randomCodePoint);
                isRenderable = isCharRenderable(randomChar); // 表示可能かチェック
            }

            // 画面に表示
            document.getElementById('unicode-container').innerText = randomChar;

            const randomCodePoint = randomChar.codePointAt(0);
            const charInfo = {
                codePoint: randomCodePoint,
                name: `U+${randomCodePoint.toString(16).toUpperCase()}`
            };

            document.getElementById('unicode-info').innerHTML = `
                文字: ${randomChar}<br>
                コードポイント: ${charInfo.name}<br>
                <a href="https://www.fileformat.info/info/unicode/char/${randomCodePoint.toString(16)}/index.htm" target="_blank">詳細を見る</a>
            `;

            history.push(randomChar);
            if (history.length > 10) history.shift();
            localStorage.setItem('history', JSON.stringify(history));
            updateHistory();
        }

        function updateHistory() {
            document.getElementById('history').innerText = "履歴: " + history.join(', ');
        }

        function addToFavorites() {
            const char = document.getElementById('unicode-container').innerText;
            if (!favorites.includes(char)) {
                favorites.push(char);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                updateFavorites();
            }
        }

        function updateFavorites() {
            document.getElementById('favorites').innerText = "お気に入りリスト: " + favorites.join(', ');
        }

        function generateHaiku() {
            const getRandomChar = () => {
                let char;
                let isRenderable = false;

                while (!isRenderable) {
                    const randomCodePoint = Math.floor(Math.random() * 0x10FFFF);
                    char = String.fromCodePoint(randomCodePoint);
                    isRenderable = isCharRenderable(char); // 表示可能かチェック
                }

                return char;
            };

            let line1 = '', line2 = '', line3 = '';
            for (let i = 0; i < 5; i++) line1 += getRandomChar();
            for (let i = 0; i < 7; i++) line2 += getRandomChar();
            for (let i = 0; i < 5; i++) line3 += getRandomChar();

            document.getElementById('haiku').innerHTML = `
                <div>俳句生成:</div>
                <div>${line1}</div>
                <div>${line2}</div>
                <div>${line3}</div>
            `;
        }

        // 文字がレンダリング可能かチェックする関数
        function isCharRenderable(char) {
            const canvas = document.getElementById('char-check-canvas');
            
            // willReadFrequently: true を設定してキャンバスコンテキストを取得
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const size = 100;

            canvas.width = size;
            canvas.height = size;

            ctx.clearRect(0, 0, size, size);

            // 基準となる記号（豆腐）を描画
            ctx.font = '100px sans-serif';
            ctx.fillText('□', 0, 100);
            const baseline = ctx.getImageData(0, 0, size, size);

            // チェックする文字を描画
            ctx.clearRect(0, 0, size, size);
            ctx.fillText(char, 0, 100);
            const charImage = ctx.getImageData(0, 0, size, size);

            // 基準の豆腐と比較
            for (let i = 0; i < baseline.data.length; i++) {
                if (baseline.data[i] !== charImage.data[i]) {
                    return true; // 違いがあれば表示可能な文字
                }
            }
            return false; // 同じなら表示不可
        }
    </script>
</body>
</html>
