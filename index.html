<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ステガノグラフィー - 画像に文字やファイルを埋め込む</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 40px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .section {
            margin-bottom: 40px;
        }
        .section h3 {
            color: #444;
            margin-bottom: 10px;
        }
        .section p {
            margin: 5px 0;
            color: #666;
        }
        input[type="file"], input[type="text"], textarea, button, select {
            margin-top: 10px;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        textarea {
            width: calc(100% - 22px);
            height: 80px;
            resize: vertical;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .image-preview {
            margin-top: 20px;
            text-align: center;
        }
        .image-preview img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            margin-top: 10px;
            padding: 10px;
            background-color: #f1f1f1;
        }
        .info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .details {
            font-size: 14px;
            margin-top: 10px;
            color: #333;
        }
        #canvas {
            display: none;
        }
        .warning {
            color: red;
        }
    </style>
</head>
<body>
    <h1>画像に文字やファイルを埋め込む</h1>

    <div class="container">
        <div class="section">
            <h3>1. 画像に文字やファイルを埋め込む</h3>
            <p>PNG、JPEG、HEIF形式の画像を選択し、隠したいデータ（文字またはファイル）を入力してください。</p>

            <div id="drop-zone" class="drop-zone">
                ここに画像ファイルをドラッグ＆ドロップしてください
                <br>または
                <input type="file" id="embedImageInput" accept="image/png, image/jpeg, image/heif" style="display: none;">
                <button onclick="document.getElementById('embedImageInput').click()">画像ファイルを選択</button>
            </div>

            <select id="embedOption" onchange="toggleInput()">
                <option value="text">文字を埋め込む</option>
                <option value="file">ファイルを埋め込む</option>
            </select>
            <div id="textInputContainer">
                <textarea id="textInput" placeholder="隠したい文字を入力" oninput="checkTextSize()"></textarea>
                <p id="embedTextCount" class="info"></p>
            </div>
            <div id="fileInputContainer" style="display:none;">
                <div id="file-drop-zone" class="drop-zone">
                    ここにファイルをドラッグ＆ドロップしてください
                    <br>または
                    <input type="file" id="fileInput" accept=".txt,.pdf,.mp3,.mp4,.docx,.xlsx,.zip,.png,.jpg,.jpeg,.gif,.csv,.json,.wav,.ogg" style="display: none;">
                    <button onclick="document.getElementById('fileInput').click()">ファイルを選択</button>
                </div>
                <p id="embedFileInfo" class="info">対応ファイル形式: .txt, .pdf, .mp3, .mp4, .docx, .xlsx, .zip, .png, .jpg, .jpeg, .gif, .csv, .json, .wav, .ogg</p>
            </div>
            <p id="embedCapacityInfo" class="info"></p>
            <button onclick="embedData()">データを埋め込む</button>
            <button onclick="downloadImage()">埋め込んだ画像をダウンロード</button>
            <div id="embedImageDetails" class="details"></div>
            <div class="image-preview" id="embedImagePreview">
                <p>アップロードした画像:</p>
                <img id="embedPreviewImage" src="" alt="プレビュー" />
            </div>
            <div class="image-preview" id="outputImagePreview">
                <p>データを埋め込んだ後の画像:</p>
                <img id="outputPreviewImage" src="" alt="プレビュー" />
            </div>
        </div>

        <div class="section">
            <h3>2. 画像から文字またはファイルを抽出</h3>
            <p>データが埋め込まれている画像を選択してください。</p>
            <input type="file" id="extractImageInput" accept="image/png, image/jpeg, image/heif">
            <button onclick="extractData()">データを抽出</button>
            <div id="extractedFilePreview" class="file-preview"></div>
            <p id="extractedData"></p>
            <div id="extractImageDetails" class="details"></div>
            <div class="image-preview" id="extractImagePreview">
                <p>アップロードした画像:</p>
                <img id="extractPreviewImage" src="" alt="プレビュー" />
            </div>
        </div>

        <canvas id="canvas"></canvas>
    </div>

    <script>
        let imgData;
        let maxDataBytes = 0;

        // ファイルの拡張子とMIMEタイプをチェックし、非対応の場合はエラーメッセージを表示
        function validateImageFile(file) {
            const validTypes = ['image/png', 'image/jpeg', 'image/heif'];
            const validExtensions = ['png', 'jpg', 'jpeg', 'heif'];
            const fileType = file.type;
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (!validTypes.includes(fileType) || !validExtensions.includes(fileExtension)) {
                alert("対応していないファイル形式です。PNG、JPEG、HEIF形式の画像を選択してください。");
                return false;
            }
            return true;
        }

        // ドラッグ＆ドロップ対応: ドロップ時にファイルを選択
        function setupDropZone(dropZoneId, inputId, handleFile) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(inputId);

            dropZone.addEventListener('dragover', (event) => {
                event.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (event) => {
                event.preventDefault();
                dropZone.classList.remove('dragover');
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files; // ファイルをinputに反映
                    handleFile(); // ファイル処理を実行
                }
            });
        }

        // ドロップゾーンとファイル入力に対応するファイル処理を設定
        setupDropZone('drop-zone', 'embedImageInput', () => handleImageUpload(null, 'embedPreviewImage', 'canvas', 'embedImageDetails'));
        setupDropZone('file-drop-zone', 'fileInput', () => handleFileUpload());

        // ファイルのアップロード（埋め込み用ファイル）
        function handleFileUpload() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                const fileSizeKB = (file.size / 1024).toFixed(2);
                if (file.size > maxDataBytes) {
                    alert(`ファイルが大きすぎます。最大 ${formatBytes(maxDataBytes)} まで埋め込むことができます。ファイルサイズ: ${formatBytes(file.size)}`);
                    return;
                }
                document.getElementById('embedFileInfo').innerText = `ファイル名: ${file.name}, サイズ: ${formatBytes(file.size)}`;
            }
        }

        // バイト数をKBまたはMBに変換して表示
        function formatBytes(bytes) {
            if (bytes >= 1048576) {
                return (bytes / 1048576).toFixed(2) + ' MB';
            } else if (bytes >= 1024) {
                return (bytes / 1024).toFixed(2) + ' KB';
            } else {
                return bytes + ' バイト';
            }
        }

        // 画像をアップロードした時のエラーハンドリングと情報表示
        function handleImageUpload(event, previewImageId, canvasId, detailsId) {
            const file = event ? event.target.files[0] : document.getElementById('embedImageInput').files[0];
            if (!validateImageFile(file)) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById(canvasId);
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                    // プレビュー画像を表示
                    document.getElementById(previewImageId).src = event.target.result;

                    // 画像詳細情報を表示
                    const fileSizeKB = (file.size / 1024).toFixed(2);
                    const pixelCount = img.width * img.height;
                    maxDataBytes = Math.floor((pixelCount * 3) / 8); // 埋め込めるデータ容量を計算
                    document.getElementById(detailsId).innerText = 
                        `画像サイズ: ${img.width} x ${img.height} ピクセル\nファイルサイズ: ${formatBytes(file.size)}\n画像形式: ${file.type}\n埋め込める最大容量: ${formatBytes(maxDataBytes)}`;
                    
                    document.getElementById('embedCapacityInfo').innerText = `この画像には最大 ${formatBytes(maxDataBytes)} まで埋め込むことができます。`;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 画像プレビューと詳細情報を表示（埋め込み用）
        document.getElementById('embedImageInput').addEventListener('change', function(e) {
            handleImageUpload(e, 'embedPreviewImage', 'canvas', 'embedImageDetails');
        });

        // 画像プレビューと詳細情報を表示（抽出用）
        document.getElementById('extractImageInput').addEventListener('change', function(e) {
            handleImageUpload(e, 'extractPreviewImage', 'canvas', 'extractImageDetails');
        });

        // 入力タイプによってUIを切り替え
        function toggleInput() {
            const embedOption = document.getElementById('embedOption').value;
            if (embedOption === 'file') {
                document.getElementById('fileInputContainer').style.display = 'block';
                document.getElementById('textInputContainer').style.display = 'none';
            } else {
                document.getElementById('fileInputContainer').style.display = 'none';
                document.getElementById('textInputContainer').style.display = 'block';
            }
        }

        // 入力文字数をチェックし、警告を表示
        function checkTextSize() {
            const text = document.getElementById('textInput').value;
            const textLength = new TextEncoder().encode(text).length; // UTF-8でのバイト数
            document.getElementById('embedTextCount').innerText = `現在の文字数: ${textLength} バイト`;
            
            if (textLength > maxDataBytes) {
                document.getElementById('embedTextCount').classList.add('warning');
                document.getElementById('embedTextCount').innerText += `（警告: 最大バイト数 ${formatBytes(maxDataBytes)} を超えています！）`;
            } else {
                document.getElementById('embedTextCount').classList.remove('warning');
            }
        }

        // テキストまたはファイルを画像に埋め込む関数
        function embedData() {
            const embedOption = document.getElementById('embedOption').value;
            let binaryData;
            let dataType;
            let fileExtension = '';
            let fileName = '';

            if (!imgData) {
                alert("画像をアップロードしてください");
                return;
            }

            if (embedOption === 'text') {
                const text = document.getElementById('textInput').value;
                const textLength = new TextEncoder().encode(text).length;
                if (textLength > maxDataBytes) {
                    alert(`テキストが長すぎます。最大 ${formatBytes(maxDataBytes)} まで埋め込むことができます。`);
                    return;
                }
                binaryData = new TextEncoder().encode(text); // テキストをUTF-8にエンコードしてバイナリに変換
                dataType = '0'; // 文字データの識別用
            } else {
                const file = document.getElementById('fileInput').files[0];
                if (!file) {
                    alert("ファイルを選択してください");
                    return;
                }
                const fileSize = file.size;
                if (fileSize > maxDataBytes) {
                    alert(`ファイルが大きすぎます。最大 ${formatBytes(maxDataBytes)} まで埋め込むことができます。`);
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    binaryData = new Uint8Array(event.target.result); // ファイルをバイナリデータに変換
                    dataType = '1'; // ファイルデータの識別用
                    fileExtension = file.name.split('.').pop(); // ファイルの拡張子を取得
                    fileName = file.name.split('.').slice(0, -1).join('.'); // ファイル名を取得
                    embedBinaryData(binaryData, dataType, fileExtension, fileName); // ファイルデータを埋め込む
                };
                reader.readAsArrayBuffer(file);
                return;
            }

            embedBinaryData(binaryData, dataType, fileExtension, fileName); // テキストデータを埋め込む
        }

        // バイナリデータを画像に埋め込む
        function embedBinaryData(binaryData, dataType, fileExtension, fileName) {
            let pixelIndex = 0;

            // データタイプ（1ビット）を最初に埋め込む
            imgData.data[pixelIndex] = (imgData.data[pixelIndex] & 0xFE) | parseInt(dataType);
            pixelIndex += 4;

            // データの長さ（32ビット）を埋め込む
            const dataLengthBinary = binaryData.length.toString(2).padStart(32, '0');
            for (let i = 0; i < dataLengthBinary.length; i++) {
                const bit = parseInt(dataLengthBinary[i]);
                imgData.data[pixelIndex] = (imgData.data[pixelIndex] & 0xFE) | bit;
                pixelIndex += 4;
            }

            // ファイル名と拡張子の長さとデータを埋め込む
            const fileNameBinary = new TextEncoder().encode(fileName).toString(2).padStart(32, '0');
            for (let i = 0; i < fileNameBinary.length; i++) {
                imgData.data[pixelIndex] = (imgData.data[pixelIndex] & 0xFE) | parseInt(fileNameBinary[i]);
                pixelIndex += 4;
            }

            const extLength = fileExtension.length.toString(2).padStart(8, '0');
            for (let i = 0; i < extLength.length; i++) {
                imgData.data[pixelIndex] = (imgData.data[pixelIndex] & 0xFE) | parseInt(extLength[i]);
                pixelIndex += 4;
            }

            for (let i = 0; i < fileExtension.length; i++) {
                const charBinary = fileExtension[i].charCodeAt(0).toString(2).padStart(8, '0');
                for (let bit of charBinary) {
                    imgData.data[pixelIndex] = (imgData.data[pixelIndex] & 0xFE) | parseInt(bit);
                    pixelIndex += 4;
                }
            }

            // データ本体を埋め込む
            for (let i = 0; i < binaryData.length; i++) {
                const byte = binaryData[i].toString(2).padStart(8, '0');
                for (let bit of byte) {
                    imgData.data[pixelIndex] = (imgData.data[pixelIndex] & 0xFE) | parseInt(bit);
                    pixelIndex += 4;
                }
            }

            const ctx = document.getElementById('canvas').getContext('2d');
            ctx.putImageData(imgData, 0, 0);

            // 埋め込んだ後の画像をプレビューに表示
            const dataUrl = canvas.toDataURL();
            document.getElementById('outputPreviewImage').src = dataUrl;

            alert("データが画像に埋め込まれました");
        }

        // 画像からデータを抽出し、プレビューを表示
        function extractData() {
            if (!imgData) {
                alert("画像をアップロードしてください");
                return;
            }

            let pixelIndex = 0;

            // データタイプを最初に取得（1ビット）
            const dataType = imgData.data[pixelIndex] & 1;
            pixelIndex += 4;

            // データの長さを取得（32ビット）
            let binaryLength = '';
            for (let i = 0; i < 32; i++) {
                const bit = imgData.data[pixelIndex] & 1;
                binaryLength += bit;
                pixelIndex += 4;
            }
            const dataLength = parseInt(binaryLength, 2);

            // ファイル名と拡張子の長さを取得（8ビット）
            let fileNameBinary = '';
            let extLengthBinary = '';
            for (let i = 0; i < 8; i++) {
                const bit = imgData.data[pixelIndex] & 1;
                fileNameBinary += bit;
                extLengthBinary += bit;
                pixelIndex += 4;
            }
            const fileName = new TextDecoder().decode(new Uint8Array(binaryData)).toString();
            const extLength = parseInt(extLengthBinary, 2);

            // 拡張子を取得
            let fileExtension = '';
            for (let i = 0; i < extLength; i++) {
                let charBinary = '';
                for (let j = 0; j < 8; j++) {
                    const bit = imgData.data[pixelIndex] & 1;
                    charBinary += bit;
                    pixelIndex += 4;
                }
                fileExtension += String.fromCharCode(parseInt(charBinary, 2));
            }

            // データを取得
            let binaryData = [];
            for (let i = 0; i < dataLength; i++) {
                let byte = '';
                for (let j = 0; j < 8; j++) {
                    const bit = imgData.data[pixelIndex] & 1;
                    byte += bit;
                    pixelIndex += 4;
                }
                binaryData.push(parseInt(byte, 2));
            }

            const extractedFilePreview = document.getElementById('extractedFilePreview');

            if (dataType === 0) {
                // テキストデータとして扱う
                const decoder = new TextDecoder();
                const extractedText = decoder.decode(new Uint8Array(binaryData));
                document.getElementById('extractedData').innerText = extractedText;
                extractedFilePreview.innerHTML = `<pre>${extractedText}</pre>`;
            } else {
                // ファイルデータとして扱う
                const blob = new Blob([new Uint8Array(binaryData)], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);

                // ファイルの種類ごとにプレビューを生成
                switch (fileExtension) {
                    case 'png':
                    case 'jpg':
                    case 'jpeg':
                    case 'gif':
                        extractedFilePreview.innerHTML = `<img src="${url}" alt="プレビュー画像" style="max-width:100%;">`;
                        break;
                    case 'txt':
                    case 'csv':
                    case 'json':
                        blob.text().then(text => extractedFilePreview.innerHTML = `<pre>${text}</pre>`);
                        break;
                    case 'pdf':
                        extractedFilePreview.innerHTML = `<embed src="${url}" type="application/pdf" width="100%" height="500px" />`;
                        break;
                    case 'mp3':
                    case 'wav':
                    case 'ogg':
                        extractedFilePreview.innerHTML = `<audio controls><source src="${url}" type="audio/${fileExtension}">音声プレビュー非対応</audio>`;
                        break;
                    case 'mp4':
                        extractedFilePreview.innerHTML = `<video controls width="100%"><source src="${url}" type="video/mp4">動画プレビュー非対応</video>`;
                        break;
                    default:
                        extractedFilePreview.innerHTML = `プレビューできません: .${fileExtension}`;
                }

                const link = document.createElement('a');
                link.href = url;
                link.download = `${fileName}.${fileExtension}`;
                link.textContent = `${fileName}.${fileExtension} をダウンロード`;
                extractedFilePreview.appendChild(link);

                document.getElementById('extractedData').innerText = "ファイルが抽出されました。";
            }
        }

        // 埋め込み後の画像をダウンロード
        function downloadImage() {
            const canvas = document.getElementById('canvas');
            const link = document.createElement('a');
            link.download = 'stego_image.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
