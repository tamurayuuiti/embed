<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ステガノグラフィー - 画像にデータを埋め込む</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
        .container { max-width: 85%; margin: 0 auto; background-color: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border-radius: 8px; }
        .section { margin-bottom: 40px; }
        .section h3 { color: #444; margin-bottom: 10px; }
        .section p { margin: 5px 0; color: #666; }
        input[type="file"], input[type="text"], textarea, button, select { margin-top: 10px; padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
        textarea { width: calc(100% - 22px); height: 80px; resize: vertical; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; margin-right: 10px; padding: 10px 20px; text-align: center; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #d3d3f3; cursor: not-allowed; }
        .center { display: block; margin-left: auto; margin-right: auto; }
        .image-preview { margin-top: 20px; text-align: center; }
        .image-preview img { max-width: 100%; max-height: 400px; height: auto; border: 1px solid #ccc; margin-top: 10px; padding: 10px; background-color: #f1f1f1; display: block; margin-left: auto; margin-right: auto; box-sizing: border-box; }
        .image-preview-container { display: flex; flex-direction: column; }
        @media (min-width: 768px) { .image-preview-container { flex-direction: row; justify-content: space-around; } .image-preview { width: 48%; } }
        .info { font-size: 14px; color: #666; margin-top: 5px; }
        .details { font-size: 14px; margin-top: 10px; color: #333; }
        .warning { color: red; }
        #dropArea { border: 2px dashed #ccc; border-radius: 5px; padding: 20px; text-align: center; cursor: pointer; }
        #dropArea.dragging { border-color: #4CAF50; }
        #textPreview { max-width: 100%; white-space: pre-wrap; word-wrap: break-word; background-color: #f9f9f9; padding: 10px; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; }
        #canvas { display: none; }
        #loadingIndicator { display: none; margin-top: 10px; }
        .loader { border: 6px solid #f3f3f3; border-radius: 50%; border-top: 6px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; display: inline-block; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #downloadButton { display: none; }
        #progressBarContainer { width: 100%; background-color: #f3f3f3; border: 1px solid #ccc; border-radius: 5px; margin-top: 10px; height: 30px; position: relative; }
        #progressBar { height: 100%; width: 0%; background-color: #4CAF50; border-radius: 5px; transition: width 0.3s; }
        #progressBarText { position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-size: 14px; line-height: 30px; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <h3>画像に文字やファイルを埋め込む</h3>
            <div id="dropArea">
                <p>ここに画像をドラッグ＆ドロップしてください</p>
                <p>または</p>
                <input type="file" id="embedImageInput" accept="image/png, image/jpeg">
            </div>
            <div id="uploadIndicator">
                <div class="loader"></div>
                <span id="progressDisplay">埋め込み中...</span>
            </div>
            <p id="uploadedImageName" class="info"></p>
            <select id="embedOption" onchange="toggleInput()">
                <option value="text">文字を埋め込む</option>
                <option value="file">ファイルを埋め込む</option>
            </select>
            <div id="textInputContainer">
                <textarea id="textInput" placeholder="隠したい文字を入力" oninput="checkTextSize()"></textarea>
                <p id="embedTextCount" class="info"></p>
            </div>
            <div id="fileInputContainer" style="display:none;">
                <div id="fileDropArea">
                    <p>ここにファイルをドラッグ＆ドロップしてください</p>
                    <p>または</p>
                    <input type="file" id="fileInput" accept=".txt,.json,.csv,.png,.jpg,.jpeg,.gif,.pdf,.wav">
                </div>
                <p id="uploadedFileName" class="info"></p>
            </div>
            <p id="embedCapacityInfo" class="info"></p>
            <button id="embedButton" onclick="embedData()">データを埋め込む</button>
            <div id="loadingIndicator">
                <div class="loader"></div>
            </div>
            <div id="progressBarContainer" style="display:none;">
                <div id="progressBar">
                    <span id="progressBarText">0%</span>
                </div>
            </div>
            <button id="downloadButton" style="display:none;" onclick="downloadImage()">埋め込んだ画像をダウンロード</button>
            <div class="image-preview-container">
                <div class="image-preview" id="embedImagePreview" style="display:none;">
                    <p>アップロードした画像:</p>
                    <img id="embedPreviewImage" src="" alt="画像のプレビュー" />
                </div>
                <div class="image-preview" id="outputImagePreview" style="display:none;">
                    <p>データを埋め込んだ後の画像:</p>
                    <img id="outputPreviewImage" src="" alt="埋め込み後の画像プレビュー" />
                </div>
            </div>
            <div id="errorDisplay"></div>
        </div>
        <canvas id="canvas"></canvas>
    </div>

    <script>
        let imgData = null;
        let maxDataBytes = 0;
        let isImageUploaded = false;
        let isFileUploaded = false;

        // 【変更厳禁】データ埋め込みのルール
        // データは画像のRGB全チャネルに対して、各ピクセルごとに1ビットずつ埋め込まれます。
        // データサイズは画像のサイズによって制限されます (画像のピクセル数 x 3 / 8)。
        // 埋め込むデータが最大容量を超えた場合、エラーメッセージを表示して処理を中止します。

        function resetUI() {
            document.getElementById('outputPreviewImage').src = '';
            document.getElementById('downloadButton').style.display = 'none';
            document.getElementById('embedTextCount').innerText = '';
            document.getElementById('errorDisplay').innerText = '';
            document.getElementById('progressBarContainer').style.display = 'none';
        }

        function validateImageFile(file) {
            const validTypes = ['image/png', 'image/jpeg'];
            if (!validTypes.includes(file.type)) {
                alert("対応していないファイル形式です。PNGまたはJPEG形式の画像を選択してください。");
                return false;
            }
            return true;
        }

        function displayProgress(message) {
            console.log("Progress:", message);
        }

        function displayError(message) {
            document.getElementById('errorDisplay').innerText = message;
        }

        function updateProgressBar(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressBarText = document.getElementById('progressBarText');
            progressBar.style.width = percent + '%';
            progressBarText.textContent = percent + '%';
        }

        function formatBytes(bytes) {
            if (bytes >= 1048576) return (bytes / 1048576).toFixed(2) + ' MB';
            if (bytes >= 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return bytes + ' バイト';
        }

        function handleImageUpload(file) {
            resetUI();
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('canvas');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                    document.getElementById('embedPreviewImage').src = event.target.result;
                    document.getElementById('embedImagePreview').style.display = 'block';

                    const pixelCount = img.width * img.height;
                    maxDataBytes = Math.floor(pixelCount * 3 / 8 * 0.8) - 1024;
                    document.getElementById('embedCapacityInfo').innerText = `最大埋め込み容量: ${formatBytes(maxDataBytes)}`;
                    isImageUploaded = true;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function embedData() {
            if (!isImageUploaded) {
                alert("画像がアップロードされていません。");
                return;
            }

            document.getElementById('loadingIndicator').style.display = 'block';
            displayProgress('データ埋め込み中...');

            const text = document.getElementById('textInput').value;
            const binaryData = new TextEncoder().encode(text);
            const dataSize = binaryData.length;

            if (dataSize > maxDataBytes) {
                displayError(`データが大きすぎます (最大: ${formatBytes(maxDataBytes)})`);
                return;
            }

            let pixelIndex = 0;
            for (let i = 0; i < binaryData.length; i++) {
                const byte = binaryData[i];
                for (let bitIndex = 0; bitIndex < 8; bitIndex++) {
                    const bit = (byte >> (7 - bitIndex)) & 1;
                    for (let channel = 0; channel < 3; channel++) {
                        imgData.data[pixelIndex] = (imgData.data[pixelIndex] & 0xFE) | bit;
                        pixelIndex++;
                    }
                }
            }

            const ctx = document.getElementById('canvas').getContext('2d');
            ctx.putImageData(imgData, 0, 0);
            const dataUrl = canvas.toDataURL();
            document.getElementById('outputPreviewImage').src = dataUrl;
            document.getElementById('outputImagePreview').style.display = 'block';
            document.getElementById('downloadButton').style.display = 'block';
            document.getElementById('loadingIndicator').style.display = 'none';

            displayProgress('データ埋め込み完了');
        }

        function downloadImage() {
            const canvas = document.getElementById('canvas');
            canvas.toBlob(function(blob) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'stego_image.png';
                link.click();
                URL.revokeObjectURL(link.href);
            });
        }

        document.getElementById('embedImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (validateImageFile(file)) {
                handleImageUpload(file);
            }
        });

        document.getElementById('embedButton').addEventListener('click', function() {
            embedData();
        });
    </script>
</body>
</html>
