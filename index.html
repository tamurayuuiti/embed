<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ステガノグラフィー - 画像にテキストを埋め込み、抽出</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 40px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .section {
            margin-bottom: 40px;
        }
        .section h3 {
            color: #444;
            margin-bottom: 10px;
        }
        .section p {
            margin: 5px 0;
            color: #666;
        }
        input[type="file"], input[type="text"], textarea, button {
            margin-top: 10px;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        textarea {
            width: calc(100% - 22px);
            height: 80px;
            resize: vertical;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .image-preview {
            margin-top: 20px;
            text-align: center;
        }
        .image-preview img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            margin-top: 10px;
            padding: 10px;
            background-color: #f1f1f1;
        }
        .info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .details {
            font-size: 14px;
            margin-top: 10px;
            color: #333;
        }
        #canvas {
            display: none;
        }
        .warning {
            color: red;
        }
    </style>
</head>
<body>
    <h1>画像にテキストを埋め込み、テキストを抽出する</h1>

    <div class="container">
        <div class="section">
            <h3>1. 画像に文字を埋め込む</h3>
            <p>PNGまたはJPEG形式の画像を選択し、隠したい文字を入力してください。</p>
            <input type="file" id="embedImageInput" accept="image/png, image/jpeg">
            <textarea id="textInput" placeholder="隠したい文字を入力" oninput="checkTextSize()"></textarea>
            <p id="embedCapacityInfo" class="info"></p>
            <p id="embedTextCount" class="info"></p>
            <button onclick="embedText()">テキストを埋め込む</button>
            <button onclick="downloadImage()">埋め込んだ画像をダウンロード</button>
            <div id="embedImageDetails" class="details"></div>
            <div class="image-preview" id="embedImagePreview">
                <p>アップロードした画像:</p>
                <img id="embedPreviewImage" src="" alt="プレビュー" />
            </div>
            <div class="image-preview" id="outputImagePreview">
                <p>文字を埋め込んだ後の画像:</p>
                <img id="outputPreviewImage" src="" alt="プレビュー" />
            </div>
        </div>

        <div class="section">
            <h3>2. 画像から文字を抽出</h3>
            <p>テキストが埋め込まれている画像を選択してください。</p>
            <input type="file" id="extractImageInput" accept="image/png, image/jpeg">
            <button onclick="extractText()">テキストを抽出</button>
            <p id="extractedText"></p>
            <div id="extractImageDetails" class="details"></div>
            <div class="image-preview" id="extractImagePreview">
                <p>アップロードした画像:</p>
                <img id="extractPreviewImage" src="" alt="プレビュー" />
            </div>
        </div>

        <canvas id="canvas"></canvas>
    </div>

    <script>
        let imgData;
        let maxTextLength = 0;

        // ファイルの拡張子とMIMEタイプをチェックし、非対応の場合はエラーメッセージを表示
        function validateImageFile(file) {
            const validTypes = ['image/png', 'image/jpeg'];
            const validExtensions = ['png', 'jpg', 'jpeg'];
            const fileType = file.type;
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (!validTypes.includes(fileType) || !validExtensions.includes(fileExtension)) {
                alert("対応していないファイル形式です。PNGまたはJPEG形式の画像を選択してください。");
                return false;
            }
            return true;
        }

        // 画像をアップロードした時のエラーハンドリングと情報表示
        function handleImageUpload(event, previewImageId, canvasId, detailsId) {
            const file = event.target.files[0];
            if (!validateImageFile(file)) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById(canvasId);
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                    // プレビュー画像を表示
                    document.getElementById(previewImageId).src = event.target.result;

                    // 画像詳細情報を表示
                    const fileSizeKB = (file.size / 1024).toFixed(2);
                    const pixelCount = img.width * img.height;
                    const maxTextBytes = Math.floor(pixelCount * 3 / 8); // 最大バイト数を計算
                    maxTextLength = maxTextBytes; // 1バイト=1文字のため
                    document.getElementById(detailsId).innerText = 
                        `画像サイズ: ${img.width} x ${img.height} ピクセル\nファイルサイズ: ${fileSizeKB} KB\n画像形式: ${file.type}\n埋め込める最大バイト数: ${maxTextBytes} バイト`;
                    
                    document.getElementById('embedCapacityInfo').innerText = `この画像には最大 ${maxTextBytes} バイト（${maxTextBytes} 文字）まで埋め込むことができます。`;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 画像プレビューと詳細情報を表示（文字埋め込み用）
        document.getElementById('embedImageInput').addEventListener('change', function(e) {
            handleImageUpload(e, 'embedPreviewImage', 'canvas', 'embedImageDetails');
        });

        // 画像プレビューと詳細情報を表示（文字抽出用）
        document.getElementById('extractImageInput').addEventListener('change', function(e) {
            handleImageUpload(e, 'extractPreviewImage', 'canvas', 'extractImageDetails');
        });

        // 入力テキストサイズをチェックし、警告を表示
        function checkTextSize() {
            const text = document.getElementById('textInput').value;
            const textLength = new TextEncoder().encode(text).length; // UTF-8でのバイト数
            document.getElementById('embedTextCount').innerText = `現在の文字数: ${textLength} バイト`;
            
            if (textLength > maxTextLength) {
                document.getElementById('embedTextCount').classList.add('warning');
                document.getElementById('embedTextCount').innerText += `（警告: 最大バイト数 ${maxTextLength} を超えています！）`;
            } else {
                document.getElementById('embedTextCount').classList.remove('warning');
            }
        }

        // テキストを画像に埋め込む関数
        function embedText() {
            const text = document.getElementById('textInput').value;
            const textLength = new TextEncoder().encode(text).length;
            if (!imgData || !text) {
                alert("画像とテキストを入力してください");
                return;
            }

            if (textLength > maxTextLength) {
                alert(`テキストが長すぎます。最大 ${maxTextLength} バイトまで埋め込むことができます。`);
                return;
            }

            const encoder = new TextEncoder();
            const binaryText = Array.from(encoder.encode(text)).map(byte => byte.toString(2).padStart(8, '0')).join('');
            const textLengthBinary = (binaryText.length / 8).toString(2).padStart(32, '0'); // バイト単位でテキスト長を埋め込む

            let pixelIndex = 0;

            // テキスト長さを最初に埋め込む（32ビット）
            for (let i = 0; i < textLengthBinary.length; i++) {
                const bit = parseInt(textLengthBinary[i]);
                imgData.data[pixelIndex] = (imgData.data[pixelIndex] & 0xFE) | bit;
                pixelIndex += 4;
            }

            // テキストをRGB全てのビットに分散して埋め込む
            for (let i = 0; i < binaryText.length; i++) {
                const bit = parseInt(binaryText[i]);
                const colorChannel = i % 3; // RGBを順に使用
                imgData.data[pixelIndex + colorChannel] = (imgData.data[pixelIndex + colorChannel] & 0xFE) | bit;
                if (colorChannel === 2) pixelIndex += 4; // R, G, Bで1ピクセル進む
            }

            const ctx = document.getElementById('canvas').getContext('2d');
            ctx.putImageData(imgData, 0, 0);

            // 埋め込んだ後の画像をプレビューに表示
            const dataUrl = canvas.toDataURL();
            document.getElementById('outputPreviewImage').src = dataUrl;

            alert("テキストが画像に埋め込まれました");
        }

        // 画像からテキストを抽出する関数
        function extractText() {
            if (!imgData) {
                alert("画像をアップロードしてください");
                return;
            }

            let binaryText = '';
            let pixelIndex = 0;

            // まずテキストの長さを取得する（32ビット）
            let binaryLength = '';
            for (let i = 0; i < 32; i++) {
                const bit = imgData.data[pixelIndex] & 1;
                binaryLength += bit;
                pixelIndex += 4;
            }
            const textLength = parseInt(binaryLength, 2);

            // テキストの長さに従ってビットを抽出
            for (let i = 0; i < textLength * 8; i++) {
                const bit = imgData.data[pixelIndex + (i % 3)] & 1; // RGB全てのビットから抽出
                binaryText += bit;
                if (i % 3 === 2) pixelIndex += 4; // 1ピクセル分進む
            }

            const byteArray = [];
            for (let i = 0; i < binaryText.length; i += 8) {
                byteArray.push(parseInt(binaryText.slice(i, i + 8), 2));
            }

            const decoder = new TextDecoder();
            const extractedText = decoder.decode(new Uint8Array(byteArray));
            document.getElementById('extractedText').innerText = extractedText;
        }

        // 埋め込み後の画像をダウンロード
        function downloadImage() {
            const canvas = document.getElementById('canvas');
            const link = document.createElement('a');
            link.download = 'stego_image.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
